name: Build Release

on:
  release:
    types: [prereleased]

permissions:
  contents: write
  packages: write

env:
  VERSION: unset

jobs:
  release-matrics:
    name: Release binary
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, freebsd, windows, darwin]
        goarch: [amd64, arm64]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: 1.23

    - name: Set version
      run: echo ::set-env name=VERSION::$(git describe --tags --abbrev=0)

    - name: Build
      run: go build -a -trimpath -o tdu-${{ matrix.goos }}-${{ matrix.goarch }} -ldflags "-X main.version=${{ env.VERSION }}"

    - name: Archive
      run: tar -czf tdu-${{ matrix.goos }}-${{ matrix.goarch }}-${{ env.VERSION }}.tar.gz tdu-${{ matrix.goos }}-${{ matrix.goarch }}

    - name: Upload
      uses: actions/upload-artifact@v2
      with:
        name: tdu-${{ matrix.goos }}-${{ matrix.goarch }}-${{ env.VERSION }}.tar.gz